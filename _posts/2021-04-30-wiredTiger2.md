---
layout: post
title:  "wiredTiger 내부 작동 방식"
summary: "MongoDB의 wiredTiger 스토리지 엔진"
author: mopower77
date: '2021-04-30'
category: mongodb
thumbnail: /assets/img/mongo/wired.png
---

## 저널로그
 - 데이터의 상태가 변경될 때마다 기록
 - 생성시점
    - 데이터의 상태가 변경될 때마다
 - 삭제시점
    - 체크포인트 발생되는 시점
 - 역할
    - 데이터 복구
    - 디스크 데이터 동기화

## 공유캐시(Buffer Pool)
 - 디스크에 저장된 데이터를 담아두는 공간
 - 쿼리 처리속도 향상  
 - 데이터 블록(페이지)단위로 저장되고 모든 요청의 데이터는 공유캐시에 담긴다.

## 리컨실리에이션
 - 데이터 병합.
   - 공유캐시에 변경된 데이터와 원본데이터를 병합.   
   - ex) 소스 병합.

## 이빅션
 - 공유캐시 데이터 제거.
   - 특정시점마다 공유캐시의 공간을 정리한다.
   - ex) jvm GC가 하는 역할을 함.

## 체크포인트
 - 저널로그 저장된 데이터와 디스크 데이터 동기화작업
 
## 블록매니저
 - 데이터 압축 및 압축해제를 담당
 - 디스크 -> 공유캐시 (압축해제)
 - 공유캐시 -> 디스크 (압축)


##wiredTiger 내부동작 
###상태변경(insert, update, delete) 요청시
 1. 트랜잭션 발동.
 2. 커서를 통해 데이터 변경.
 3. MVCC,스킵리스트 기법들을 사용해서 공유캐시에 저장
 4. 커서를 통해 결과값 리턴
 5. 저널로그에 저장
 6. 트랜잭션 완료.

###조회(find) 요청시
 1. 커서를 통해 조회
 2. 공유캐시에 있다면 바로 결과값 리턴
 3. 없다면 디스크로부터 데이터 블록(페이지)단위로 가져와 공유캐시에 저장하고 결과 값 리턴


###특정 시점에 이빅션이 실행
 1. 공유캐시에서 삭제할 데이터들을 찾는다
    - 해저드포인터를 기준으로 사용되는 데이터들을 제외
    - 오래전에 공유캐시에 저장된 데이터들
 2. 위를 기준으로 데이터들을 공유캐시에저 제거한다

###체크포인트 발생
 1. 발생시점을 기준으로 저널로그에 기록된 데이터를 가져온다
 2. 이를 기준으로 공유캐시에 변경된 데이터와 원본데이터를 리컨실리에이션을 통해 병합
 3. 블록매니저를 통해 압축 한뒤 디스크에 저장
 4. 발생시점 이전에 저널로그에 저장된 로그 및 공유캐시 데이터삭제.

