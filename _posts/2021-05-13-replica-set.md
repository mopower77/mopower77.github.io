---
layout: post
title:  "Replica(복제)"
summary: "Replica(복제), Replica-set"
author: mopower77
date: '2021-05-20'
category: mongodb
thumbnail: /assets/img/mongo/replicaset.png
---

## Replica(복제)
 - 서로 다른 디비간의 동일한 데이터 동기화
 - 물리복제
    - 덤프
 - 논리복제
    - 레플리카셋
 - 복제를 하는 이유
   - 데이터 복구
   - 고가용성(롱런~~)
   - 분산처리(샤딩) 

## Replica-set(레플리카 셋)
 - 데이터 동기화 그룹
 - 그룹원
   - 프라이머리
   - 세컨드리 
   - 아비터
 - 규칙
   - 오직 하나의 프라이머리를 가진다
   - 민주주의 방식으로 진행(투표)
   - 최소 3개이상
     - ex) 프라이머리1, 세컨드리2
     - ex) 프라이머리1, 세컨드리1, 아비터1

---

|   분류         |  프라이머리        |     세컨드리       |  아비터       |
|:-------------- | :-----------------:| :----------------: | :-----------: |
|서버            | 마스터             | 슬레이브           | 모니터링      |
|데이터 유무     | O                  | O                  | X             |
|데이터 변경     | 가능               | 불가능             | 불가능        |
|데이터 조회     | 가능               | 가능               | 불가능        |
|스텝업, 스텝다운| 가능               | 가능               | 불가능        | 
|프라이머리 선출참여| 가능            | 가능               | 가능          |
|서버 상태체크   | O                   | O                 | O             |


---

## 프라이머리
 - 데이터 상태변경(insert, update, delete) 가능
 - 데이터 조회(find) 가능
 - 데이터 상태변경시 OpLog에 저장(저널로그와는 다름)
 - 상황에 따라 스텝다운
    - 스텝다운: 프라이머리 -> 세컨드리

## 세컨드리
 - 데이터 조회(find)만 가능
 - OpLog에서 데이터를 가져와 실시간 동기화  
 - 상황에 따라 스텝업
    - 스텝업 : 세컨드리 -> 프라이머리 

## 아비터
 - 데이터 없음
 - 디비들 간의 상태체크만 함
    - ex) heartBeat
 - 프라이머리 선출에 참여 가능

---

## 레플리카셋 동작원리
  - 데이터를 변경하면 프라이머리서버에서 데이터를 갱신하고 OpLog에 저장
  - 세컨드리는 실시간으로 프라이머리의 OpLog에 접근해서 데이터를 동기화.
  - 각 멤버들은 서로간에 허트비트를 날리면서 상태를 체크.
  - 세컨드리는 프라이머리가 부하가 심할 경우 조회를 하기도 함(설정에 따라)
  - 위와 같은 방식을 반복적으로 실행
  - 이때 프라이머리(마스터)서버가 외부요인으로 서버가 다운 됫을 경우 살아 있는 멤버들끼리 투표를 통해 세컨드리는 프라이머리로 스텝업
  - 아비터는 데이터를 관리 하지 않기때문에 투표에만 참여할 뿐 프라이머리가 될 수 없다.