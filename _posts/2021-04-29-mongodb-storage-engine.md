---
layout: post
title:  "MongoDB 스토리지엔진"
summary: "MongoDB 스토리지 엔진"
author: mopower77
date: '2021-04-29'
category: mongodb
thumbnail: /assets/img/posts/hello.jpg
---
  
### 스토리지 엔진
 - 데이터를 디스크와 메모리에 저장, 삭제, 읽어오는 역할을 담당.
 - 하나의 몽고디비 서버에 하나의 스토리지 엔진만 사용가능.

### 스토리지 엔진의 종류
 - MMAPv1
 - WiredTiger
 - In-Memory
 - RocksDB
 - TokuDB


##MMAPv1 스토리지 엔진
 - 몽고디비 초기 스토리지 엔진(ver 3.0까지 사용)
 - 컬렉션 단위의 잠금
 - 내장된 캐시기능이 없음

##WiredTiger 스토리지 엔진
 - MMAPv1 다음에 나온 엔진(ver 3.2)
 - 장금 경함 최소화(Lock-free Algorithm)가 이 엔진의 핵심
   - 스킵 리스트
   - 해저드 포인터
   - MVCC (Multi Version Concurrency Control) 
 - 도큐먼트 단위 잠금
 - 데이터 암호화 및 압축 기능

###해저드 포인터(Hazard Pointer)
 - 사용되고있는 데이터 페이지의 포인터들을 관리하는 리스트
 - 예)
   - 모든 쿼리는 무조건 공유캐시(버퍼풀)을 거쳐야 한다
   - 그리고 사용자 쿼리의 관련된 모든 데이터는 공유캐시(버버풀)에 상주해 있다
   - 이 공유캐시도 용량이 무한하지 않기때문에 특정 시점에는 비워주어야 한다
   - 이때 해저드 포인터가 없다면 사용되고잇는 데이터를 사용이 끝날때까지 기다렷다가 삭제를 하던가 해야 할 것이다.
   - 하지만 해저드포인터를 통해 참조되고있는 데이터들을 제외하고 나머지것들만 지워주면 대기없이 바로 가능하다.

###스킵리스트
 - 자료구조 중에 하나로 이름에서처럼 스킵을 하면서 데이터를 관리 할 수 있다.
 - 재정렬이 필요 없다.  
 - 링크드리스트와 비교하자면 다음을 가리키는 포인터가 하나이지만 스킵리스트는 포인터가 여러개이다.
   - 다음을 가리키는 포인터가 여러개라는 말은 특정 규칙을 통해 첫 노드가 2번째노드를 4번째 노드를 가리킬 수 있다는 뜻이다.
   - 위와 같은 구조로 되어있어 모든 데이터를 조회하는게 아니라 스킵하면서 데이터를 조회 할 수 있다.

###MVCC (Multi Version Concurrency Control)
- 멀티버전 동시성 제어
- 하나의 데이터가 여러개의 버전으로 나누어져있고 이를 통해 동시성 문제를 해결  
  - 예)
    - db.users.update({id: 5}) 쿼리를 날린다.
    - 이때 기존의 데이터는 그대로 두고 갱신된 user.id = 5 의 값을 새로 추가하고 버전을 기록한다.  
    - 이처럼 데이터의 상태가 변경될때마다 새로 추가를 해주고 버전을 기록한다.
    - 변경 뒤 데이터를 조회 할때 제일 마지막 버전의 값을 돌려준다.
    - 기존의 데이터는 그대로 두고 버전별로 데이터를 새로 생성함으로서 동시에 조회 및 변경시에 잠김없이 처리가 가능하다.
    
